---
title: "WHAM example 6: Numbers-at-age"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WHAM example 6: Numbers-at-age}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
wham.dir <- find.package("wham")
knitr::opts_knit$set(root.dir = file.path(wham.dir,"extdata"))
library(knitr)
library(kableExtra)
```
In this vignette we walk through an example using the `wham` (WHAM = Woods Hole Assessment Model) package to run a state-space age-structured stock assessment model. WHAM is a generalization of code written for [Miller et al. (2016)](https://doi.org/10.1139/cjfas-2015-0339) and [Xu et al. (2018)](https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236), and in this example we apply WHAM to the same stock, Southern New England / Mid-Atlantic Yellowtail Flounder. 

This is the 6th WHAM example, which blends aspects from examples [1](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_SNEMA_yellowtail_flounder.R), [2](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex2_CPI_recruitment_SNEMA_yellowtail.R), and [5](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex5_GSI_M.R). We assume you already have `wham` installed. If not, see the [README](https://github.com/timjmiller/wham#installation-and-basic-use). The simpler 1st example is available as a [R script](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_SNEMA_yellowtail_flounder.R) and [vignette](https://github.com/timjmiller/wham/blob/master/vignettes/ex1_SNEMA_yellowtail_flounder.Rmd).

As in example 1:

- Stock: Southern New England-Mid Atlantic (SNEMA) yellowtail flounder
- Data: 1973-2011, 1 fishery and 2 indices
- Age compositions: logistic normal, without pooling zero observations (`input$data$age_comp_model_fleets = 7` and `input$data$age_comp_model_indices = 7`)
- Selectivity: age-specific

As in example 2:

- Beverton-Holt recruitment (`recruit_model = 3`)
- Environmental covariate (ecov) modeled as an AR1 process (`ecov$process_model = 'ar1'`)
- Compare with and w/o ecov having a "limiting" (e.g. carrying capacity) effect on recruitment (`ecov$how = 2`)

As in example 5:

- Environmental covariate: Gulf Stream Index (GSI)
- 2D AR1 deviations by age and year (random effects)

Example 6 highlights WHAM's options for treating the yearly transitions in numbers-at-age (i.e. survival):

1. deterministic (as in statistical catch-at-age models, recruitment deviations are independent fixed effects)
2. recruitment deviations (from Bev-Holt expectation) are random effects
  - independent
  - AR1 deviations by year (autocorrelated)
3. "full state-space model" (survival of all ages are random effects)
  - independent
  - AR1 deviations by age
  - AR1 deviations by year
  - 2D AR1 deviations by age and year

## 1. Load data

Open R and load the `wham` package:

```{r message=FALSE}
# devtools::install_github("timjmiller/wham", dependencies=TRUE)
library(tidyverse)
library(wham)
```

For a clean, runnable `.R` script, look at `ex6_NAA.R` in the `example_scripts` folder of the `wham` package install:
```{r eval=FALSE}
wham.dir <- find.package("wham")
file.path(wham.dir, "example_scripts")
```

You can run this entire example script with:
```{r, eval=FALSE}
write.dir <- "choose/where/to/save/output" # otherwise will be saved in working directory
source(file.path(wham.dir, "example_scripts", "ex6_NAA.R"))
```

Let's create a directory for this analysis:
```{r, eval=FALSE}
# choose a location to save output, otherwise will be saved in working directory
write.dir <- "choose/where/to/save/output"
dir.create(write.dir)
setwd(write.dir)
```

We need the same ASAP data file as in [example 1](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_SNEMA_yellowtail_flounder.R), and the environmental covariate (Gulf Stream Index, GSI). Let's copy `ex1_SNEMAYT.dat` and `GSI.csv` to our analysis directory:
```{r eval=FALSE}
wham.dir <- find.package("wham")
file.copy(from=file.path(wham.dir,"extdata","ex1_SNEMAYT.dat"), to=write.dir, overwrite=FALSE)
file.copy(from=file.path(wham.dir,"extdata","GSI.csv"), to=write.dir, overwrite=FALSE)
```

Confirm you are in the correct directory and it has the required data files:
```{r eval=FALSE}
list.files()
```

Read the ASAP3 .dat file into R and convert to input list for wham:
```{r eval=FALSE}
asap3 <- read_asap3_dat("ex1_SNEMAYT.dat")
```

Load the environmental covariate (Gulf Stream Index, GSI) data into R:
```{r}
env.dat <- read.csv("GSI.csv", header=T)
head(env.dat)
```

As in example 5, the GSI data file does not have a standard error estimate, either for each yearly observation or one overall value. In such a case, WHAM can estimate the observation error for the environmental covariate, either as one overall value, $\sigma_E$, or yearly values as random effects, $\mathrm{log}\sigma_{E_y} \sim \mathcal{N}(\mathrm{log}\sigma_E, \sigma^2_{\sigma_E})$. In this example we choose the simpler option and estimate one observation error parameter, shared across years.

## 2. Specify models

Now we specify several models with different options for the numbers-at-age (NAA) transitions, i.e. survival:
```{r}
df.mods <- data.frame(NAA_cor = c('---','iid','ar1_y','iid','ar1_a','ar1_y','2dar1'),
                      NAA_sigma = c('---',rep("rec",2),rep("rec+1",4)),
                      GSI_how = c(rep(0,7),rep(2,7)), stringsAsFactors=FALSE)
n.mods <- dim(df.mods)[1]
df.mods$Model <- paste0("m",1:n.mods)
df.mods <- df.mods %>% select(Model, everything()) # moves Model to first col
```

Look at the model table:
```{r}
df.mods
```

## 3. Numbers-at-age options

To specify the options for modeling NAA transitions, include an optional list argument, `NAA_re`, to the  `prepare_wham_input` function (see the `?prepare_wham_input` help page). ASAP3 does not estimate random effects, and therefore these options are not specified in the ASAP data file. By default (`NAA_re` is `NULL` or not included), WHAM fits a traditional statistical catch-at-age model (NAA = predicted NAA for all ages, i.e. survival is deterministic). To fit a state-space model, we must specify `NAA_re`.

`NAA_re` is a list with the following entries:

- `$sigma`: Which ages allow deviations from pred_NAA? Common options are specified with strings.
  - `"rec"`: Recruitment deviations are random effects, survival of all other ages is deterministic
  - `"rec+1"`: Survival of all ages is stochastic ("full state space model"), with 2 estimated $\sigma_a$, one for recruitment and one shared among other ages
- `$cor`: Correlation structure for the NAA deviations. Options are:
  - `"iid"`: NAA deviations vary by year and age, but uncorrelated.
  - `"ar1_a"`: NAA deviations correlated by age (AR1).
  - `"ar1_y"`: NAA deviations correlated by year (AR1).
  - `"2dar1"`: NAA deviations correlated by year and age (2D AR1, as for $M$ in example 5).

Alternatively, you can specify a more complex `NAA_re$sigma` by entering a vector with length equal to the number of ages, where each entry points to the $\sigma_a$ to use for that age. For example, `NAA_re$sigma = c(1,2,2,3,3,3)` will estimate 3 $\sigma_a$, with recruitment (age-1) deviations having their own $\sigma_R$, ages 2-3 sharing $\sigma_2$, and ages 4-6 sharing $\sigma_3$.

For example, to fit model `m1` (SCAA):

```{r eval=FALSE}
NAA_re <- NULL # or simply leave out of call to prepare_wham_input
```

To fit model `m3`, recruitment deviations are correlated random effects:

```{r eval=FALSE}
NAA_re <- list(sigma="rec", cor="ar1_y")
```

And to fit model `m7`, numbers at all ages are random effects correlated by year AND age:

```{r eval=FALSE}
NAA_re <- list(sigma="rec+1", cor="2dar1")
```

## 4. Linking recruitment to an environmental covariate (GSI)

As described in [example 2](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex2_CPI_recruitment_SNEMA_yellowtail.R), the environmental covariate options are fed to `prepare_wham_input` as a list, `ecov`. This example differs from example 2 in that:

- `$logsigma = "est_1"`: estimate the observation error for the GSI (one overall value for all years). The other option is `"est_re"` to allow the GSI observation error to have yearly fluctuations (random effects). The Cold Pool Index in example 2 had yearly observation errors given.
- `$how`: `ecov$how = 0` estimates the GSI time-series model (AR1) for models without a GSI-Recruitment effect, in order to compare AIC with models that do include the effect. Setting `ecov$how = 2` specifies that the GSI affects the Beverton-Holt $b$ parameter ("limiting" / carrying capacity effect).
- `$link_model`: specifies the model linking GSI to $b$. Here, we specify a linear GSI-$b$ effect with `ecov$link_model = "linear"`.

For example, the `ecov` list for models `m8`-`m14` with the linear GSI-$b$ effect:

```{r eval=FALSE}
  # example for model m3
  ecov <- list(
    label = "GSI",
    mean = as.matrix(env.dat$GSI),
    logsigma = 'est_1', # estimate obs sigma, 1 value shared across years
    year = env.dat$year,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (=1)
    lag = 1, # GSI in year t affects recruitment in year t+1
    process_model = "ar1", # GSI modeled as AR1 (random walk would be "rw")
    where = "recruit", # GSI affects recruitment
    how = 2, # limiting
    link_model = "linear") # linear GSI-Recruitment effect
```

Note that you can set `ecov = NULL` to fit the model without environmental covariate data, but here we fit the `ecov` data even for models without the GSI effect on recruitment (`m1`-`m7`) so that we can compare them via AIC (need to have the same data in the likelihood). We accomplish this by setting `ecov$how = 0` and `ecov$process_model = "ar1"`.

## 5. Run all models

All models use the same options for expected recruitment (Beverton-Holt stock-recruit function) and selectivity (age-specific, with one or two ages fixed at 1).

```{r eval=FALSE}
for(m in 1:n.mods){
  NAA_list <- list(cor=df.mods[m,"NAA_cor"], sigma=df.mods[m,"NAA_sigma"])
  if(NAA_list$sigma == '---') NAA_list = NULL

  ecov <- list(
    label = "GSI",
    mean = as.matrix(env.dat$GSI),
    logsigma = 'est_1', # estimate obs sigma, 1 value shared across years
    year = env.dat$year,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (=1)
    lag = 1, # GSI in year t affects Rec in year t + 1
    process_model = 'ar1', # "rw" or "ar1"
    where = "recruit", # GSI affects recruitment
    how = df.mods$GSI_how[m], # 0 = no effect (but still fit Ecov to compare AIC), 2 = limiting
    link_model = "linear")

  input <- prepare_wham_input(asap3, recruit_model = 3, # Bev Holt recruitment
                              model_name = "Ex 6: Numbers-at-age",
                              selectivity=list(model=rep("age-specific",3), 
                                re=rep("none",3), 
                                initial_pars=list(c(0.5,0.5,0.5,1,1,0.5),c(0.5,0.5,0.5,1,0.5,0.5),c(0.5,1,0.5,0.5,0.5,0.5)), 
                                fix_pars=list(c(4,5),4,2)),
                              NAA_re = NAA_list,
                              ecov=ecov)

  # overwrite age comp model (all models use logistic normal)
  input$data$age_comp_model_indices = rep(7, input$data$n_indices)
  input$data$age_comp_model_fleets = rep(7, input$data$n_fleets)
  input$data$n_age_comp_pars_indices = rep(1, input$data$n_indices)
  input$data$n_age_comp_pars_fleets = rep(1, input$data$n_fleets)
  input$par$index_paa_pars = rep(0, input$data$n_indices)
  input$par$catch_paa_pars = rep(0, input$data$n_fleets)
  input$map = input$map[!(names(input$map) %in% c("index_paa_pars", "catch_paa_pars"))]

  # Fit model
  btime = Sys.time()
  mod <- fit_wham(input, do.retro=T, do.osa=F)
  mod$runtime = round(difftime(Sys.time(), btime, units = "mins"),1)

  # Save model
  saveRDS(mod, file=paste0(df.mods$Model[m],".rds"))

  # Plot output in new subfolder
  # plot_wham_output(mod=mod, dir.main=file.path(getwd(),df.mods$Model[m]), out.type='html')
  
  # Do projections
  # mod_proj <- project_wham(mod)
  # saveRDS(mod_proj, file=paste0(df.mods$Model[m],"_proj.rds"))
}
```

## 6. Compare models

```{r include=FALSE}
data(vign6_res)
```

Collect all models into a list.
  
```{r eval=FALSE}
mod.list <- paste0(df.mods$Model,".rds")
mods <- lapply(mod.list, readRDS)
```

Get model convergence and stats.

```{r eval=FALSE}
df.mods$na_sdrep <- sapply(mods, function(x) x$na_sdrep)
df.mods$runtime <- sapply(mods, function(x) x$runtime)
df.mods$NLL <- sapply(mods, function(x) round(x$opt$objective,3))
df.aic <- as.data.frame(compare_wham_models(mods, sort=FALSE, calc.rho=T)$tab)
minAIC <- min(df.aic$AIC, na.rm=T)
df.aic$dAIC <- round(df.aic$AIC - minAIC,1)
df.mods <- cbind(df.mods, df.aic)
rownames(df.mods) <- NULL
```

Look at results table.

```{r eval=FALSE}
df.mods
```

## 7. Results

Two models had very similar AIC and were overwhelmingly supported relative to the other models (bold in table below): `m12` (all NAA are random effects with correlation by age, GSI-Recruitment effect) and `m14` (all NAA are random effects with correlation by age and year, GSI-Recruitment effect).

In the table, `Pos def Hessian` highlights models for which `TMB::sdreport(mod)` successfully inverted the Hessian and produced SE estimates for all (fixed effect) parameters. This information is stored in `mod$na_sdrep` (should be `FALSE`) and `mod$sdrep$pdHess` (should be `TRUE`).

```{r echo=FALSE}
vign6_res[,10:12] = round(vign6_res[,10:12], 3)
vign6_res[,5] = ifelse(vign6_res[,5]==FALSE,TRUE,FALSE)

posdef = which(vign6_res$na_sdrep == TRUE)
thebest = which(vign6_res$dAIC < 1)
vign6_res %>%
  dplyr::rename("Pos def\nHessian"="na_sdrep", "Runtime\n(min)"="runtime", "$\\Delta AIC$"="dAIC",
         "$\\rho_{R}$"="rho_R", "$\\rho_{SSB}$"="rho_SSB", "$\\rho_{\\overline{F}}$"="rho_Fbar") %>%
  kable(escape = F) %>%
  kable_styling(bootstrap_options = c("condensed","responsive")) %>%
  row_spec(posdef, background = gray.colors(10,end=0.95)[10]) %>%
  row_spec(thebest, bold=TRUE)
```

#### Estimated *M*

- Models allowed to estimate mean $M$ increased $M$ compared to the fixed values in `m1-3` (more green/yellow than blue).
- Models that estimated $M_a$ had highest $M_a$ for ages 4-5.
- Models that estimated $M_y$ had higher $M_y$ in the early 1990s and around 2000.

![Natural mortality by age (y-axis) and year (x-axis) for all models.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/MAA.png){ width=90% }

#### Retrospective patterns

Compared to `m1`, the retrospective pattern for `m8` was worse for recruitment (`m8` 0.31, `m1` 0.26) but improved for SSB (`m8` 0.01, `m1` 0.11) and F (`m8` -0.03, `m1` -0.13). In general, models with GSI effects or 2D AR1 deviations on $M$ had reduced retrospective patterns compared to the status quo (`m1`) and models with 1D AR1 random effects on $M$. Compare the retrospective patterns of numbers-at-age, SSB, and F for models `m1` (left, fixed $M_a$) and `m8` (right, estimated $M$ + 2D AR1 deviations).

![Mohn's rho for numbers-at-age, m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m1_NAA_retro_relative.png){ width=45% }![Mohn's rho for numbers-at-age, m8.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m8_NAA_retro_relative.png){ width=45% }

![Mohn's rho for SSB, m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m1_SSB_retro_relative.png){ width=45% }![Mohn's rho for SSB, m8.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m8_SSB_retro_relative.png){ width=45% }

![Mohn's rho for F, m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m1_Fbar_retro_relative.png){ width=45% }![Mohn's rho for F, m8.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m8_Fbar_retro_relative.png){ width=45% }

It is also worth noting that, although the Hessian was not positive definite, model `m17` had the lowest retrospective pattern across all numbers-at-age, SSB, and F. Model `m17` left $M_a$ fixed at the values from the ASAP data file (as in `m1`) and estimated 2D AR1 deviations around these mean $M_a$. This is how $M$ was modeled in [Cadigan (2016)](https://www.nrcresearchpress.com/doi/10.1139/cjfas-2015-0047).

![Mohn's rho for SSB, m17.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m17_SSB_retro_relative.png){ width=45% }![Mohn's rho for F, m17.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m17_Fbar_retro_relative.png){ width=45% }

![Mohn's rho for recruitment, m17.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m17_NAA_age1_retro_relative.png){ width=45% }

#### Stock status

Compared to `m1` (left), `m8` (center) estimated higher *M*, lower and more uncertain *F*, and higher SSB -- a much rosier picture of the stock status through time. Model `m17` (right) is intermediate between `m1` and `m8`.

![Relative stock status, m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m1_FSPR_relative.png){ width=31% }![Relative stock status, m8.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m8_FSPR_relative.png){ width=31% }![Relative stock status, m17.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m17_FSPR_relative.png){ width=31% }

Compared to `m1` (left), `m8` (center) estimated higher and more variable reference points, $F_{\%SPR}$ (top), and lower and more variable yield-per-recruit (bottom). Model `m17` (right) estimated a shift in yield-per-recruit from ~0.10 before 1990 (as in `m1`) to ~0.05 after 1990 (as in `m8`).

![Reference point variability, m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m1_FSPR_annual_time.png){ width=31% }![Reference point variability, m8.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m8_FSPR_annual_time.png){ width=31% }![Reference point variability, m17.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m17_FSPR_annual_time.png){ width=31% }

In the final year (2011), `m8` estimated a lower probability of the stock being overfished (4% vs. 19%).

![Kobe status plot, m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m1_Kobe_status.png){ width=45% }![Kobe status plot, m8.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex5_plots/m8_Kobe_status.png){ width=45% }

### Yet more *M* options

If you want to estimate M-at-age shared/mirrored among *some but not all ages*, you'll need to modify `input$map$M_a` after calling `prepare_wham_input`.

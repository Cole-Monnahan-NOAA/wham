---
title: "WHAM example 5: Time-varying natural mortality (+/- Gulf Stream Index effect on M)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WHAM example 5: Time-varying natural mortality (+/- Gulf Stream Index effect on M)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
wham.dir <- find.package("wham")
knitr::opts_knit$set(root.dir = file.path(wham.dir,"extdata"))
```
In this vignette we walk through an example using the `wham` (WHAM = Woods Hole Assessment Model) package to run a state-space age-structured stock assessment model. WHAM is a generalization of code written for [Miller et al. (2016)](https://doi.org/10.1139/cjfas-2015-0339) and [Xu et al. (2018)](https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236), and in this example we apply WHAM to the same stock, Southern New England / Mid-Atlantic Yellowtail Flounder. 

This is the 5th `wham` example, which builds off [example 2](https://github.com/timjmiller/wham/blob/mortality/inst/example_scripts/ex2_CPI_recruitment_SNEMA_yellowtail.R):

- full state-space model (numbers-at-age are random effects for all ages, `input$data$use_NAA_re = 1`)
- logistic normal age compositions, pooling zero observations (`input$data$age_comp_model_fleets = 5` and `input$data$age_comp_model_indices = 5`)
- random-about-mean recruitment (`recruit_model = 2`)
- 5 indices
- fit to 1973-2011 data

We assume you already have `wham` installed. If not, see the [README](https://github.com/timjmiller/wham#installation-and-basic-use). The simpler 1st example, without environmental effects or time-varying M, is available as a [R script](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_SNEMA_yellowtail_flounder.R) and [vignette](https://github.com/timjmiller/wham/blob/master/vignettes/ex1_SNEMA_yellowtail_flounder.Rmd).

In example 5, we demonstrate how to specify and run WHAM with varying options for natural mortality:

- not estimated (fixed at input values)
- one value, $\mu_M$
- age-specific, $M_a$ (independent)
- function of weight-at-age, $M_{y,a} = \mu_M * W_{y,a}^b$
- AR1 deviations (random effects, by age), $M_{y,a} = \mu_M + \delta_a \quad\mathrm{and}\quad \delta_a \sim \mathcal{N} (\rho_a \delta_{a-1}, \sigma^2_M)$
- AR1 deviations (random effects, by year), $M_{y,a} = \mu_M + \delta_y \quad\mathrm{and}\quad \delta_y \sim \mathcal{N} (\rho_y \delta_{y-1}, \sigma^2_M)$
- 2D AR1 deviations (random effects, by age and year), $M_{y,a} = M_a + \delta_{y,a} \quad\mathrm{and}\quad \delta_{y,a} \sim \mathcal{N}(0,\Sigma)$)

We also demonstrate alternate specifications for the link between M and an environmental covariate, the Gulf Stream Index (GSI), as in [O'Leary et al. (2019)](https://www.nrcresearchpress.com/doi/10.1139/cjfas-2018-0092):

- none

- linear (in log-space), $M_{y,a} = e^{\mathrm{log}\mu_M + \beta_1 E_y}$

- quadratic (in log-space), $M_{y,a} = e^{\mathrm{log}\mu_M + \beta_1 E_y + \beta_2 E^2_y}$

Note that you can specify more than one of the above effects on $M$, although the model may not be estimable. For example, the most complex model with weight-at-age, 2D AR1 age- and year-deviations, and a quadratic environmental effect: $M_{y,a} = e^{\mathrm{log}\mu_M + b W_{y,a} + \beta_1 E_y + \beta_2 E^2_y + \delta_{y,a}}$.

## 1. Load data

Open R and load the `wham` package:

```{r message=FALSE}
library(wham)
```

For a clean, runnable `.R` script, look at `ex5_GSI_M.R` in the `example_scripts` folder of the `wham` package install:
```{r eval=FALSE}
wham.dir <- find.package("wham")
file.path(wham.dir, "example_scripts")
```

You can run this entire example script with:
```{r, eval=FALSE}
write.dir <- "choose/where/to/save/output" # otherwise will be saved in working directory
source(file.path(wham.dir, "example_scripts", "ex5_GSI_M.R"))
```

Let's create a directory for this analysis:
```{r, eval=FALSE}
# choose a location to save output, otherwise will be saved in working directory
write.dir <- "choose/where/to/save/output"
dir.create(write.dir)
setwd(write.dir)
```

We need the same ASAP data file as in [example 2](https://github.com/timjmiller/wham/blob/mortality/inst/example_scripts/ex2_CPI_recruitment_SNEMA_yellowtail.R), and the environmental covariate (GSI). Let's copy `ex2_SNEMAYT.dat` and `GSI.csv` to our analysis directory:
```{r eval=FALSE}
wham.dir <- find.package("wham")
file.copy(from=file.path(wham.dir,"extdata","ex2_SNEMAYT.dat"), to=write.dir, overwrite=FALSE)
file.copy(from=file.path(wham.dir,"extdata","GSI.csv"), to=write.dir, overwrite=FALSE)
```

Confirm you are in the correct directory and it has the required data files:
```{r}
list.files()
```

Read the ASAP3 .dat file into R and convert to input list for wham:
```{r}
asap3 <- read_asap3_dat("ex2_SNEMAYT.dat")
```

Load the environmental covariate (Gulf Stream Index, GSI) data into R:
```{r}
env.dat <- read.csv("GSI.csv", header=T)
```

The GSI does not have a standard error estimate, either for each yearly observation or one overall value. In such a case, WHAM can estimate the observation error for the environmental covariate, either as one overall value or yearly values (random effects $\mathrm{log}\sigma^E_y \sim \mathcal{N}(\mathrm{log}\sigma^E, \sigma^2_{\sigma^E})$). We will estimate one observation error parameter, shared across years.
```{r}
head(env.dat)
```

## 2. Specify models

Now we specify several models with different options for natural mortality:
```{r}
df.mods <- data.frame(M_model = c(rep("---",3),"age-specific","weight-at-age",rep("constant",6),"age-specific","age-specific",rep("constant",3)),
                      M_re = c(rep("none",6),"ar1_y","2dar1","none","none","2dar1","none","2dar1",rep("ar1_a",3)),
                      Ecov_process = rep("ar1",16),
                      Ecov_link = c(0,1,2,rep(0,5),1,2,1,2,2,0,1,2), stringsAsFactors=FALSE)
n.mods <- dim(df.mods)[1]
df.mods$Model <- paste0("m",1:n.mods)
df.mods <- df.mods %>% select(Model, everything()) # moves Model to first col
```

Look at the model table
```{r}
df.mods
```

## 3. Natural mortality options

Next we specify the options for modeling natural mortality by including an optional list argument, `M`, to the  `prepare_wham_input` function (see the `?prepare_wham_input` help page). `M` specifies estimation options and can overwrite M-at-age values specified in the ASAP data file. By default (i.e. `M` is `NULL` or not included), the M-at-age matrix from the ASAP data file is used (M fixed, not estimated). `M` is a list with the following entries:

- `$model`: Natural mortality model options.
  - `"constant"`: estimate a single M, $\mu_M$, shared across all ages and years.
  - `"age-specific"`: estimate $M_a$ independent for each age, shared across years.
  - `"weight-at-age"`: estimate $M$ as a function of weight-at-age, $M_{y,a} = \mu_M * W_{y,a}^b$, as in [Lorenzen (1996)](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1095-8649.1996.tb00060.x).{https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1095-8649.1996.tb00060.x) and [Miller & Hyun (2018)](https://www.nrcresearchpress.com/doi/10.1139/cjfas-2017-0035).
- `$re`: Time- and age-varying random effects on $M$.
  - `"none"`: $M$ constant in time and across ages (default).
  - `"iid"`: $M$ varies by year and age, but uncorrelated.
  - `"ar1_a"`: $M$ correlated by age (AR1), constant in time.
  - `"ar1_y"`: $M$ correlated by year (AR1), constant by age.
  - `"2dar1"`: $M$ correlated by year and age (2D AR1), as in [Cadigan (2016)](https://www.nrcresearchpress.com/doi/10.1139/cjfas-2015-0047).
- `$initial_means`: Initial/mean M-at-age vector, with length = number of ages (if `$model = "age-specific"`) or 1 (if `$model = "weight-at-age"` or `"constant"`). If `NULL`, initial mean M-at-age values are taken from the first row of the MAA matrix in the ASAP data file.
- `$est_ages`: Vector of ages to estimate age-specific M (others will be fixed at initial values). E.g. in a model with 6 ages, `$est_ages = 5:6` will estimate M for the 5th and 6th ages, and fix M for ages 1-4. If `NULL`, M at all ages is fixed at `M$initial_means` (if not `NULL`) or row 1 of the MAA matrix from the ASAP file (if `M$initial_means = NULL`).
- `$logb_prior`: (Only for weight-at-age model) TRUE or FALSE (default), should a $\mathcal{N}(0.305, 0.08)$ prior be used on `log_b`? Based on Fig. 1 and Table 1 (marine fish) in [Lorenzen (1996)](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1095-8649.1996.tb00060.x).

For example, to fit model `m1` (fix $M_a$ at values in ASAP file):

```{r}
M <- NULL # or simply leave out of call to prepare_wham_input
```

To fit model `m6` (estimate one $M$, constant by year and age):

```{r}
M <- list(model="constant", est_ages=1)
```

And to fit model `m8` (estimate mean $M$ with 2D AR1 deviations by year and age):

```{r}
M <- list(model="constant", est_ages=1, re="2dar1")
```

To use the $M_a$ values specified in the ASAP file, but with 2D AR1 deviations (as in [Cadigan (2016)](https://www.nrcresearchpress.com/doi/10.1139/cjfas-2015-0047)):

```{r}
M <- list(re="2dar1")
```

## 4. Linking *M* to an environmental covariate (GSI)

As described in [example 2](https://github.com/timjmiller/wham/blob/mortality/inst/example_scripts/ex2_CPI_recruitment_SNEMA_yellowtail.R), the environmental covariate (Ecov) options are fed to `prepare_wham_input` as a list, `Ecov`. This example differs from example 2 in that:

- `$logsigma = "est_1"`: estimate the observation error for the GSI (one overall value for all years). The other option is `"est_re"` to allow the GSI observation error to have yearly fluctuations (random effects). The Cold Pool Index in example 2 had yearly observation errors given.
- `$lag = 0`: GSI in year *t* affects $M$ in year *t*, instead of year *t+1*.
- `$where = "M"`: GSI affects $M$, instead of recruitment.
- `$how`: `ecov$how = 0` estimates the GSI time-series model (AR1) for models without a GSI-M effect, in order to compare AIC with models that do include a GSI-M effect. Setting `ecov$how = 1` is necessary to allow a GSI-M effect.
- `$link_model`: specifies the model linking GSI to $M$. Can be `NA` (no effect, default), `"linear"`, or `"poly-x"` (where x is the degree of a polynomial). In this example we demonstrate models with no GSI-M effect, a linear GSI-M effect, and a quadratic GSI-M effect (`"poly-2"`). WHAM includes a function to calculate orthogonal polynomials in TMB, akin to the [`poly()`](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/poly) function in R.

For example, the `ecov` list for model `m3` with a quadratic GSI-M effect:

```{r eval=FALSE}
  # example for model m3
  ecov <- list(
    label = "GSI",
    mean = as.matrix(env.dat$GSI),
    logsigma = 'est_1', # estimate obs sigma, 1 value shared across years
    year = env.dat$year,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (=1)
    lag = 0, # GSI in year t affects M in same year
    process_model = "ar1", # GSI modeled as AR1 (random walk would be "rw")
    where = "M", # GSI affects natural mortality
    how = 1, # include GSI effect on M
    link_model = "poly-2") # quadratic GSI-M effect
```

Note that you can set `ecov = NULL` to fit the model without environmental covariate data, but here we fit the `ecov` data even for models without GSI effect on $M$ (`m1`, `m4-8`, `m14`) so that we can compare them via AIC (need to have the same data in the likelihood). We accomplish this by setting `ecov$how = 0` and `ecov$process_model = "ar1"`.

## 5. Run all models

All models use the same options for recruitment (random-about-mean, no stock-recruit function) and selectivity (logistic, with parameters fixed for indices 4 and 5).

```{r eval=FALSE}
df.mods$runtime <- c()
env.dat <- read.csv("GSI.csv", header=T)
for(m in 1:n.mods){
  ecov <- list(
    label = "GSI",
    mean = as.matrix(env.dat$GSI),
    logsigma = 'est_1', # estimate obs sigma, 1 value shared across years
    year = env.dat$year,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (=1)
    lag = 0, # GSI in year t affects M in same year
    process_model = df.mods$Ecov_process[m], # "rw" or "ar1"
    where = "M", # GSI affects natural mortality
    how = ifelse(df.mods$Ecov_link[m]==0,0,1),
    link_model = c(NA,"linear","poly-2")[df.mods$Ecov_link[m]+1])

  if(m < 4) df.mods$M_model[m] = "age-specific"
  if(df.mods$M_model[m] %in% c("constant","weight-at-age")) est_ages = 1
  if(df.mods$M_model[m] == "age-specific") est_ages = 1:asap3$dat$n_ages
  if(m < 4) est_ages = NULL
  
  M <- list(
    model = df.mods$M_model[m],
    re = df.mods$M_re[m],
    est_ages = est_ages
  )
  if(df.mods$M_model[m] == "constant") M$initial_means = 0.28

  input <- prepare_wham_input(asap3, recruit_model = 2,
                              model_name = "Ex 5: GSI effects on M",
                              ecov = ecov,
                              selectivity=list(model=rep("logistic",6),
                                               initial_pars=c(rep(list(c(3,3)),4), list(c(1.5,0.1), c(1.5,0.1))),
                                               fix_pars=c(rep(list(NULL),4), list(1:2, 1:2))),
                              M=M)

  # overwrite age comp model (all models use logistic normal)
  input$data$age_comp_model_fleets = rep(5, input$data$n_fleets) # 5 = logistic normal (pool zero obs)
  input$data$n_age_comp_pars_fleets = c(0,1,1,3,1,2)[input$data$age_comp_model_fleets]
  input$data$age_comp_model_indices = rep(5, input$data$n_indices) # 5 = logistic normal (pool zero obs)
  input$data$n_age_comp_pars_indices = c(0,1,1,3,1,2)[input$data$age_comp_model_indices]
  n_catch_acomp_pars = c(0,1,1,3,1,2)[input$data$age_comp_model_fleets[which(apply(input$data$use_catch_paa,2,sum)>0)]]
  n_index_acomp_pars = c(0,1,1,3,1,2)[input$data$age_comp_model_indices[which(apply(input$data$use_index_paa,2,sum)>0)]]
  input$par$catch_paa_pars = rep(0, sum(n_catch_acomp_pars))
  input$par$index_paa_pars = rep(0, sum(n_index_acomp_pars))

  # Full state-space model, abundance is the state vector
  input$data$use_NAA_re = 1
  input$data$random_recruitment = 0
  input$map = input$map[!(names(input$map) %in% c("log_NAA", "log_NAA_sigma", "mean_rec_pars"))] # remove from map (i.e. estimate)
  input$map$log_R = factor(rep(NA, length(input$par$log_R)))
  input$random = c(input$random, "log_NAA")

  # Fit model
  btime = Sys.time()
  mod <- fit_wham(input, do.retro=T, do.osa=F) # turn off OSA residuals to save time
  df.mods$runtime[m] = round(difftime(Sys.time(), btime, units = "mins"),1)

  # Save model
  saveRDS(mod, file=paste0(df.mods$Model[m],".rds"))

  # Plot output in new subfolder
  # plot_wham_output(mod=mod, dir.main=file.path(getwd(),df.mods$Model[m]), out.type='html')
}
```

## 6. Compare models

```{r include=FALSE}
data(vign5_res)
# data(vign5_MAA)
```

Collect all models into a list.
  
```{r eval=FALSE}
mod.list <- paste0(df.mods$Model,".rds")
mods <- lapply(mod.list, readRDS)
```

Add results to model table.

```{r eval=FALSE}
df.mods$na_sdrep <- sapply(mods, function(x) x$na_sdrep)
df.mods$Ecov_link <- c("---","linear","poly-2")[df.mods$Ecov_link+1]
df.mods$M_re[df.mods$M_re=="none"] = "---"
df.mods$M_model[1:3] = "---"
colnames(df.mods)[2] = "M_est"
df.mods$runtime <- runtime
df.mods$NLL <- sapply(mods, function(x) round(x$opt$objective,3))

# deal with m11 having NaN
mods[[11]] <- NULL
df.aic <- as.data.frame(compare_wham_models(mods, sort=FALSE, calc.rho=T)$tab)
df.aic <- rbind(df.aic[1:10,],rep(NA,5),df.aic[11:15,])

# only calculate AIC and dAIC for converged models with positive definite Hessian
df.aic$AIC[df.mods$na_sdrep==TRUE | is.na(df.mods$na_sdrep)] <- NA
minAIC <- min(df.aic$AIC, na.rm=T)
df.aic$dAIC <- round(df.aic$AIC - minAIC,1)
df.mods <- cbind(df.mods, df.aic)
rownames(df.mods) <- NULL
```

Look at results table.

```{r eval=FALSE}
df.mods
```

```{r echo=FALSE}
vign5_res
```

## 7. Results

In general, models with GSI effects or 2D AR1 deviations on $M$ had reduced retrospective patterns compared to the status quo (`m1`) and models with 1D AR1 random effects on $M$.

Model `m8` (estimate mean $M$ and 2D AR1 deviations by year and age, no GSI effect) had the lowest AIC and was overwhelmingly supported relative to the other models. Compared to `m1`, the retrospective pattern for `m8` was worse for recruitment (`m8` 0.31, `m1` 0.26) but improved for SSB (`m8` 0.01, `m1` 0.11) and F (`m8` -0.03, `m1` -0.13).

### Yet more *M* options

If you want to estimate M-at-age shared/mirrored among *some but not all ages*, you'll need to modify `input$map$M_a` after calling `prepare_wham_input`. For example:

```{r eval=F}

```


<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ex 4: Selectivity with time- and age-varying random effects • wham</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Ex 4: Selectivity with time- and age-varying random effects">
<meta property="og:description" content="wham">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wham</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/">Source code</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../mailto:fisheries.toolbox@noaa.gov">
    <span class="far fa far fa-paper-plane fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ex 4: Selectivity with time- and age-varying random effects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timjmiller/wham/blob/master/vignettes/ex4_selectivity.Rmd"><code>vignettes/ex4_selectivity.Rmd</code></a></small>
      <div class="hidden name"><code>ex4_selectivity.Rmd</code></div>

    </div>

    
    
<p>In this vignette we walk through an example using the <code>wham</code> (WHAM = Woods Hole Assessment Model) package to run a state-space age-structured stock assessment model. WHAM is a generalization of code written for <a href="https://doi.org/10.1139/cjfas-2015-0339">Miller et al. (2016)</a> and <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236">Xu et al. (2018)</a>, and in this example we apply WHAM to the same stock, Southern New England / Mid-Atlantic Yellowtail Flounder.</p>
<p>Here we assume you already have <code>wham</code> installed. If not, see the <a href="https://github.com/timjmiller/wham#installation-and-basic-use">README</a>. This is the 4th <code>wham</code> example, which builds off model <code>m4</code> from <a href="https://timjmiller.github.io/wham/articles/ex1_SNEMA_yellowtail_flounder.html">example 1</a>:</p>
<ul>
<li><p>full state-space model (numbers-at-age are random effects for all ages, <code>NAA_re = list(sigma='rec+1',cor='iid')</code>)</p></li>
<li><p>logistic normal age compositions, treating observations of zero as missing (<code>input$data$age_comp_model_fleets = 7</code> and <code>input$data$age_comp_model_indices = 7</code>)</p></li>
<li><p>random-about-mean recruitment (<code>recruit_model = 2</code>)</p></li>
<li><p>no environmental covariate (<code>ecov = NULL</code>)</p></li>
<li><p>2 indices</p></li>
<li><p>fit to 1973-2016 data</p></li>
</ul>
<p>In example 4, we demonstrate the time-varying selectivity options in WHAM for both logistic and age-specific selectivity:</p>
<ul>
<li><p><code>none</code>: time-constant</p></li>
<li><p><code>iid</code>: parameter- and year-specific (random effect) deviations from mean selectivity parameters</p></li>
<li><p><code>ar1</code>: as above, but estimate correlation across logistic parameters</p></li>
<li><p><code>ar1_y</code>: as above, but estimate correlation across years</p></li>
<li><p><code>2dar1</code>: as above, but estimate correlation across both years and parameters</p></li>
</ul>
<p>Note that each of these options can be applied to any selectivity block (and therefore fleet/catch or index/survey).</p>
<div id="load-data" class="section level2">
<h2 class="hasAnchor">
<a href="#load-data" class="anchor"></a>1. Load data</h2>
<p>Open R and load the <code>wham</code> package:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">wham</span>)</pre></body></html></div>
<p>For a clean, runnable <code>.R</code> script, look at <code>ex4_selectivity.R</code> in the <code>example_scripts</code> folder of the <code>wham</code> package install:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">wham.dir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html">find.package</a></span>(<span class="st">"wham"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">wham.dir</span>, <span class="st">"example_scripts"</span>)</pre></body></html></div>
<p>You can run this entire example script with:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">write.dir</span> <span class="kw">&lt;-</span> <span class="st">"choose/where/to/save/output"</span> <span class="co"># otherwise will be saved in working directory</span>
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">wham.dir</span>, <span class="st">"example_scripts"</span>, <span class="st">"ex4_selectivity.R"</span>))</pre></body></html></div>
<p>Let’s create a directory for this analysis:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># choose a location to save output, otherwise will be saved in working directory</span>
<span class="no">write.dir</span> <span class="kw">&lt;-</span> <span class="st">"choose/where/to/save/output"</span> <span class="co"># need to change</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="no">write.dir</span>)
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="no">write.dir</span>)</pre></body></html></div>
<p>We need the same data files as in <a href="https://timjmiller.github.io/wham/articles/ex1_SNEMA_yellowtail_flounder.html">example 1</a>. Let’s copy <code>ex1_SNEMAYT.dat</code> to our analysis directory:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">wham.dir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html">find.package</a></span>(<span class="st">"wham"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw">from</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">wham.dir</span>,<span class="st">"extdata"</span>,<span class="st">"ex1_SNEMAYT.dat"</span>), <span class="kw">to</span><span class="kw">=</span><span class="no">write.dir</span>, <span class="kw">overwrite</span><span class="kw">=</span><span class="fl">FALSE</span>)</pre></body></html></div>
<p>Confirm you are in the correct directory and it has the required data files:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>()
<span class="co">#&gt;  [1] "CPI.csv"                "ex1_SNEMAYT.dat"        "ex1_test_results.rds"  </span>
<span class="co">#&gt;  [4] "ex2_SNEMAYT.dat"        "ex2_test_results.rds"   "ex4_test_results.rds"  </span>
<span class="co">#&gt;  [7] "ex5_summerflounder.dat" "ex5_test_results.rds"   "ex6_test_results.rds"  </span>
<span class="co">#&gt; [10] "GSI.csv"</span></pre></body></html></div>
<p>Read the ASAP3 .dat file into R and convert to input list for wham:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">asap3</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_asap3_dat.html">read_asap3_dat</a></span>(<span class="st">"ex1_SNEMAYT.dat"</span>)</pre></body></html></div>
</div>
<div id="specify-selectivity-model-options" class="section level2">
<h2 class="hasAnchor">
<a href="#specify-selectivity-model-options" class="anchor"></a>2. Specify selectivity model options</h2>
<p>We are going to run 9 models that differ only in the selectivity options:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># m1-m5 logistic, m6-m9 age-specific</span>
<span class="no">sel_model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"logistic"</span>,<span class="fl">5</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"age-specific"</span>,<span class="fl">4</span>))

<span class="co"># time-varying options for each of 3 blocks (b1 = fleet, b2-3 = indices)</span>
<span class="no">sel_re</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"none"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>), <span class="co"># m1-m5 logistic</span>
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iid"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>),
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ar1"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>),
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ar1_y"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>),
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2dar1"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>),
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"none"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>), <span class="co"># m6-m9 age-specific</span>
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iid"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>),
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ar1_y"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>),
                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2dar1"</span>,<span class="st">"none"</span>,<span class="st">"none"</span>))
<span class="no">n.mods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sel_re</span>)

<span class="co"># summary data frame</span>
<span class="no">df.mods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Model</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="fl">1</span>:<span class="no">n.mods</span>),
    <span class="kw">Selectivity</span><span class="kw">=</span><span class="no">sel_model</span>, <span class="co"># Selectivity model (same for all blocks)</span>
    <span class="kw">Block1_re</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">sel_re</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span><span class="kw">[[</span><span class="fl">1</span>]])) <span class="co"># Block 1 random effects</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">df.mods</span>) <span class="kw">&lt;-</span> <span class="kw">NULL</span>

<span class="no">df.mods</span>
<span class="co">#&gt;   Model  Selectivity Block1_re</span>
<span class="co">#&gt; 1    m1     logistic      none</span>
<span class="co">#&gt; 2    m2     logistic       iid</span>
<span class="co">#&gt; 3    m3     logistic       ar1</span>
<span class="co">#&gt; 4    m4     logistic     ar1_y</span>
<span class="co">#&gt; 5    m5     logistic     2dar1</span>
<span class="co">#&gt; 6    m6 age-specific      none</span>
<span class="co">#&gt; 7    m7 age-specific       iid</span>
<span class="co">#&gt; 8    m8 age-specific     ar1_y</span>
<span class="co">#&gt; 9    m9 age-specific     2dar1</span></pre></body></html></div>
</div>
<div id="setup-and-run-models" class="section level2">
<h2 class="hasAnchor">
<a href="#setup-and-run-models" class="anchor"></a>3. Setup and run models</h2>
<p>The ASAP data file specifies selectivity options (model, initial parameter values, which parameters to fix/estimate). WHAM uses these by default in order to facilitate running ASAP models. To see the currently specified selectivity options in <code>asap3</code>:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">asap3</span>$<span class="no">dat</span>$<span class="no">sel_block_assign</span> <span class="co"># 1 fleet, all years assigned to block 1</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
<span class="co">#&gt; [39] 1 1 1 1 1 1</span>
<span class="co"># by default each index gets its own selectivity block (here, blocks 2 and 3)</span>

<span class="no">asap3</span>$<span class="no">dat</span>$<span class="no">sel_block_option</span> <span class="co"># fleet selectivity (1 block), 2 = logistic</span>
<span class="co">#&gt; [1] 2</span>
<span class="no">asap3</span>$<span class="no">dat</span>$<span class="no">index_sel_option</span> <span class="co"># index selectivity (2 blocks), 2 = logistic</span>
<span class="co">#&gt; [1] 2 2</span>

<span class="no">asap3</span>$<span class="no">dat</span>$<span class="no">sel_ini</span> <span class="co"># fleet sel initial values (col1), estimation phase (-1 = fix)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;       [,1] [,2] [,3] [,4]</span>
<span class="co">#&gt;  [1,] 0.10    1    0    1</span>
<span class="co">#&gt;  [2,] 1.00   -1    0    1</span>
<span class="co">#&gt;  [3,] 0.42    1    0    1</span>
<span class="co">#&gt;  [4,] 0.58    1    0    1</span>
<span class="co">#&gt;  [5,] 0.74    1    0    1</span>
<span class="co">#&gt;  [6,] 0.90    1    0    1</span>
<span class="co">#&gt;  [7,] 1.00    2    0    1</span>
<span class="co">#&gt;  [8,] 0.90    3    0    1</span>
<span class="co">#&gt;  [9,] 0.50    1    0    1</span>
<span class="co">#&gt; [10,] 0.60    1    0    1</span>
<span class="co">#&gt; [11,] 4.00    1    0    1</span>
<span class="co">#&gt; [12,] 1.10    1    0    1</span>
<span class="no">asap3</span>$<span class="no">dat</span>$<span class="no">index_sel_ini</span> <span class="co"># index sel initial values (col1), estimation phase (-1 = fix)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;       [,1] [,2] [,3] [,4]</span>
<span class="co">#&gt;  [1,] 0.10    1    0    1</span>
<span class="co">#&gt;  [2,] 0.26    1    0    1</span>
<span class="co">#&gt;  [3,] 1.00   -1    0    1</span>
<span class="co">#&gt;  [4,] 0.58    1    0    1</span>
<span class="co">#&gt;  [5,] 0.74    1    0    1</span>
<span class="co">#&gt;  [6,] 0.90    1    0    1</span>
<span class="co">#&gt;  [7,] 1.50    2    0    1</span>
<span class="co">#&gt;  [8,] 0.90    3    0    1</span>
<span class="co">#&gt;  [9,] 0.75    1    0    1</span>
<span class="co">#&gt; [10,] 0.60    1    0    1</span>
<span class="co">#&gt; [11,] 4.00    1    0    1</span>
<span class="co">#&gt; [12,] 1.10    1    0    1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt;       [,1] [,2] [,3] [,4]</span>
<span class="co">#&gt;  [1,] 0.10    1    0    1</span>
<span class="co">#&gt;  [2,] 1.00   -1    0    1</span>
<span class="co">#&gt;  [3,] 0.42    1    0    1</span>
<span class="co">#&gt;  [4,] 0.58    1    0    1</span>
<span class="co">#&gt;  [5,] 0.74    1    0    1</span>
<span class="co">#&gt;  [6,] 0.90    1    0    1</span>
<span class="co">#&gt;  [7,] 1.00    2    0    1</span>
<span class="co">#&gt;  [8,] 0.90    3    0    1</span>
<span class="co">#&gt;  [9,] 0.50    1    0    1</span>
<span class="co">#&gt; [10,] 0.60    1    0    1</span>
<span class="co">#&gt; [11,] 4.00    1    0    1</span>
<span class="co">#&gt; [12,] 1.10    1    0    1</span></pre></body></html></div>
<p>When we specify the WHAM model with <code><a href="../reference/prepare_wham_input.html">prepare_wham_input()</a></code>, we can overwrite the selectivity options from the ASAP data file with the optional list argument <code>selectivity</code>. The selectivity model is chosen via <code>selectivity$model</code>:</p>
<table class="table">
<thead><tr class="header">
<th>Model</th>
<th><code>selectivity$model</code></th>
<th>No. Parameters</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Age-specific</td>
<td><code>"age-specific"</code></td>
<td><code>n_ages</code></td>
</tr>
<tr class="even">
<td>Logistic (increasing)</td>
<td><code>"logistic"</code></td>
<td>2</td>
</tr>
<tr class="odd">
<td>Double logistic (dome)</td>
<td><code>"double-logistic"</code></td>
<td>4</td>
</tr>
<tr class="even">
<td>Logistic (decreasing)</td>
<td><code>"decreasing-logistic"</code></td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Regardless of the selectivity model used, we incorporate time-varying selectivity by estimating a mean for each selectivity parameter, <span class="math inline">\(\mu^{s}_a\)</span>, and (random effect) deviations from the mean, <span class="math inline">\(\delta_{a,y}\)</span>. We then estimate the selectivity parameters, <span class="math inline">\(s_{a,y}\)</span>, on the logit-scale with (possibly) lower and upper limits: <span class="math display">\[s_{a,y} = \mathrm{lower} + \frac{\mathrm{upper} - \mathrm{lower}}{1 + e^{-(\mu^{s}_a + \delta_{a,y})}}\]</span></p>
<p>The deviations, <span class="math inline">\(\boldsymbol{\delta}\)</span>, follow a 2-dimensional AR(1) process defined by the parameters <span class="math inline">\(\sigma^2_s\)</span>, <span class="math inline">\(\rho_a\)</span>, and <span class="math inline">\(\rho_y\)</span>: <span class="math display">\[\boldsymbol{\delta} \sim \mathrm{MVN}(0,\Sigma)\]</span> <span class="math display">\[\Sigma = \sigma^2_s(\mathrm{R}_a \otimes \mathrm{R}_y)\]</span> <span class="math display">\[R_{a,a^*} = \rho_a^{\vert a - a^* \vert}\]</span> <span class="math display">\[R_{y,y^*} = \rho_y^{\vert y - y^* \vert}\]</span></p>
<p>Mean selectivity parameters can be initialized at different values from the ASAP file with <code>selectivity$initial_pars</code>. Parameters can be fixed at their initial values by specifying <code>selectivity$fix_pars</code>. Finally, we specify any time-varying (random effects) on selectivity parameters (<code>selectivity$re</code>):</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th><code>selectivity$re</code></th>
<th>Deviations from mean</th>
<th>Estimated parameters</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>"none"</code></td>
<td>time-constant (no deviation)</td>
<td></td>
</tr>
<tr class="even">
<td><code>"iid"</code></td>
<td>independent, identically-distributed</td>
<td><span class="math inline">\(\sigma^2\)</span></td>
</tr>
<tr class="odd">
<td><code>"ar1"</code></td>
<td>autoregressive-1 (correlated across ages/parameters)</td>
<td>
<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\rho_a\)</span>
</td>
</tr>
<tr class="even">
<td><code>"ar1_y"</code></td>
<td>autoregressive-1 (correlated across years)</td>
<td>
<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\rho_y\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"2dar1"</code></td>
<td>2D AR1 (correlated across both years and ages/parameters)</td>
<td>
<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\rho_a\)</span>, <span class="math inline">\(\rho_y\)</span>
</td>
</tr>
</tbody>
</table>
<p>Now we can run the above models in a loop:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">inv.logit</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">x</span>)/(<span class="fl">1</span>+<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">x</span>))
<span class="kw">for</span>(<span class="no">m</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n.mods</span>){
    <span class="kw">if</span>(<span class="no">sel_model</span>[<span class="no">m</span>] <span class="kw">==</span> <span class="st">"logistic"</span>){ <span class="co"># logistic selectivity</span>
        <span class="co"># overwrite initial parameter values in ASAP data file (ex1_SNEMAYT.dat)</span>
        <span class="no">input</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span>(<span class="no">asap3</span>, <span class="kw">model_name</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Model "</span>,<span class="no">m</span>), <span class="no">sel_model</span>[<span class="no">m</span>], <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">sel_re</span><span class="kw">[[</span><span class="no">m</span>]], <span class="kw">collapse</span><span class="kw">=</span><span class="st">"-"</span>), <span class="kw">sep</span><span class="kw">=</span><span class="st">": "</span>), <span class="kw">recruit_model</span><span class="kw">=</span><span class="fl">2</span>,
                    <span class="kw">selectivity</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">model</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"logistic"</span>,<span class="fl">3</span>), <span class="kw">re</span><span class="kw">=</span><span class="no">sel_re</span><span class="kw">[[</span><span class="no">m</span>]], <span class="kw">initial_pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.5</span>,<span class="fl">0.2</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">0.2</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">0.2</span>))),
                    <span class="kw">NAA_re</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">sigma</span><span class="kw">=</span><span class="st">'rec+1'</span>,<span class="kw">cor</span><span class="kw">=</span><span class="st">'iid'</span>))
    } <span class="kw">else</span> { <span class="co"># age-specific selectivity</span>
        <span class="co"># # don't fix any ages</span>
        <span class="co"># input &lt;- prepare_wham_input(asap3, model_name=paste(paste0("Model ",m), sel_model[m], paste(sel_re[[m]], collapse="-"), sep=": "), recruit_model=2, </span>
        <span class="co">#           selectivity=list(model=rep("age-specific",3), re=sel_re[[m]], </span>
        <span class="co">#               initial_pars=list(rep(0.5,6), rep(0.5,6), rep(0.5,6))),</span>
        <span class="co">#           NAA_re = list(sigma='rec+1',cor='iid'))</span>

        <span class="co"># fix selectivity for one age per block: 4 / 4 / 2</span>
        <span class="no">input</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span>(<span class="no">asap3</span>, <span class="kw">model_name</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Model "</span>,<span class="no">m</span>), <span class="no">sel_model</span>[<span class="no">m</span>], <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">sel_re</span><span class="kw">[[</span><span class="no">m</span>]], <span class="kw">collapse</span><span class="kw">=</span><span class="st">"-"</span>), <span class="kw">sep</span><span class="kw">=</span><span class="st">": "</span>), <span class="kw">recruit_model</span><span class="kw">=</span><span class="fl">2</span>,
                    <span class="kw">selectivity</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">model</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"age-specific"</span>,<span class="fl">3</span>), <span class="kw">re</span><span class="kw">=</span><span class="no">sel_re</span><span class="kw">[[</span><span class="no">m</span>]],
                        <span class="kw">initial_pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">inv.logit</span>(-<span class="fl">4</span>),<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>)),
                        <span class="kw">fix_pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span>)),
                    <span class="kw">NAA_re</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">sigma</span><span class="kw">=</span><span class="st">'rec+1'</span>,<span class="kw">cor</span><span class="kw">=</span><span class="st">'iid'</span>))
    }

    <span class="co"># overwrite age comp model (all models use logistic normal)</span>
    <span class="no">input</span>$<span class="no">data</span>$<span class="no">age_comp_model_indices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">7</span>, <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_indices</span>)
    <span class="no">input</span>$<span class="no">data</span>$<span class="no">age_comp_model_fleets</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">7</span>, <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_fleets</span>)
    <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_age_comp_pars_indices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_indices</span>)
    <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_age_comp_pars_fleets</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_fleets</span>)
    <span class="no">input</span>$<span class="no">par</span>$<span class="no">index_paa_pars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_indices</span>)
    <span class="no">input</span>$<span class="no">par</span>$<span class="no">catch_paa_pars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">input</span>$<span class="no">data</span>$<span class="no">n_fleets</span>)
    <span class="no">input</span>$<span class="no">map</span> <span class="kw">=</span> <span class="no">input</span>$<span class="no">map</span>[!(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">input</span>$<span class="no">map</span>) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"index_paa_pars"</span>, <span class="st">"catch_paa_pars"</span>))]

    <span class="co"># fit model</span>
    <span class="no">mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span>(<span class="no">input</span>, <span class="kw">do.osa</span><span class="kw">=</span><span class="no">F</span>, <span class="kw">do.proj</span><span class="kw">=</span><span class="no">F</span>, <span class="kw">do.retro</span><span class="kw">=</span><span class="no">F</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">mod</span>, <span class="kw">file</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="no">m</span>,<span class="st">".rds"</span>))
}</pre></body></html></div>
</div>
<div id="model-convergence-and-comparison" class="section level2">
<h2 class="hasAnchor">
<a href="#model-convergence-and-comparison" class="anchor"></a>4. Model convergence and comparison</h2>
<p>Collect all models into a list:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">mod.list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">write.dir</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="fl">1</span>:<span class="no">n.mods</span>,<span class="st">".rds"</span>))
<span class="no">mods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">mod.list</span>, <span class="no">readRDS</span>)</pre></body></html></div>
<p>Check which models converged. Note that 3 of the 9 models did NOT converge:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="../reference/check_convergence.html">check_convergence</a></span>(<span class="no">x</span>))</pre></body></html></div>
<pre><code>#&gt; [[1]]
#&gt; [1] "stats:nlminb thinks the model has converged: mod$opt$convergence == 0"
#&gt; [2] "Maximum gradient component: 7.53e-10 "                                
#&gt; [3] "Max gradient parameter: F_devs "                                      
#&gt; [4] "TMB:sdreport() was performed successfully for this model"             
#&gt; 
#&gt; [[2]]
#&gt; [1] "stats:nlminb thinks the model has converged: mod$opt$convergence == 0"
#&gt; [2] "Maximum gradient component: 7.96e-13 "                                
#&gt; [3] "Max gradient parameter: logit_q "                                     
#&gt; [4] "TMB:sdreport() was performed successfully for this model"             
#&gt; 
#&gt; [[3]]
#&gt; [1] "stats:nlminb thinks the model has converged: mod$opt$convergence == 0"
#&gt; [2] "Maximum gradient component: 5.84e-09 "                                
#&gt; [3] "Max gradient parameter: sel_repars "                                  
#&gt; [4] "TMB:sdreport() was performed successfully for this model"             
#&gt; 
#&gt; [[4]]
#&gt; [1] "stats:nlminb thinks the model has NOT converged: mod$opt$convergence != 0"             
#&gt; [2] "Maximum gradient component: NaN "                                                      
#&gt; [3] "Max gradient parameter:  "                                                             
#&gt; [4] "TMB:sdreport() was performed for this model, but it appears hessian was not invertible"
#&gt; 
#&gt; [[5]]
#&gt; [1] "stats:nlminb thinks the model has converged: mod$opt$convergence == 0"
#&gt; [2] "Maximum gradient component: 1.60e-12 "                                
#&gt; [3] "Max gradient parameter: F_devs "                                      
#&gt; [4] "TMB:sdreport() was performed successfully for this model"             
#&gt; 
#&gt; [[6]]
#&gt; [1] "stats:nlminb thinks the model has converged: mod$opt$convergence == 0"
#&gt; [2] "Maximum gradient component: 1.92e-11 "                                
#&gt; [3] "Max gradient parameter: log_F1 "                                      
#&gt; [4] "TMB:sdreport() was performed successfully for this model"             
#&gt; 
#&gt; [[7]]
#&gt; [1] "stats:nlminb thinks the model has NOT converged: mod$opt$convergence != 0"
#&gt; [2] "Maximum gradient component: 1.17e+05 "                                    
#&gt; [3] "Max gradient parameter: logit_selpars "                                   
#&gt; [4] "TMB:sdreport() was performed successfully for this model"                 
#&gt; 
#&gt; [[8]]
#&gt; [1] "stats:nlminb thinks the model has converged: mod$opt$convergence == 0"
#&gt; [2] "Maximum gradient component: 1.38e-06 "                                
#&gt; [3] "Max gradient parameter: log_F1 "                                      
#&gt; [4] "TMB:sdreport() was performed successfully for this model"             
#&gt; 
#&gt; [[9]]
#&gt; [1] "stats:nlminb thinks the model has NOT converged: mod$opt$convergence != 0"             
#&gt; [2] "Maximum gradient component: NaN "                                                      
#&gt; [3] "Max gradient parameter:  "                                                             
#&gt; [4] "TMB:sdreport() was performed for this model, but it appears hessian was not invertible"</code></pre>
<p>Plot output for models that converged (in a subfolder for each model):</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">conv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">opt</span>$<span class="no">convergence</span> <span class="kw">==</span> <span class="fl">0</span>)
<span class="no">conv_mods</span> <span class="kw">&lt;-</span> (<span class="fl">1</span>:<span class="no">n.mods</span>)[<span class="no">conv</span>] <span class="co"># 0 means converged</span>
<span class="kw">for</span>(<span class="no">m</span> <span class="kw">in</span> <span class="no">conv_mods</span>){
    <span class="fu"><a href="../reference/plot_wham_output.html">plot_wham_output</a></span>(<span class="kw">mod</span><span class="kw">=</span><span class="no">mods</span><span class="kw">[[</span><span class="no">m</span>]], <span class="kw">out.type</span><span class="kw">=</span><span class="st">'html'</span>, <span class="kw">dir.main</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">write.dir</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="no">m</span>)))
}</pre></body></html></div>
<p>Compare the models using AIC:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">df.aic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/compare_wham_models.html">compare_wham_models</a></span>(<span class="no">mods</span>, <span class="kw">sort</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">calc.rho</span><span class="kw">=</span><span class="fl">FALSE</span>)$<span class="no">tab</span>)
<span class="no">df.aic</span>[!<span class="no">conv</span>,] <span class="kw">=</span> <span class="fl">NA</span> <span class="co"># don't get AIC for unconverged models</span>
<span class="no">minAIC</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">df.aic</span>$<span class="no">AIC</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="no">T</span>)
<span class="no">df.aic</span>$<span class="no">dAIC</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">df.aic</span>$<span class="no">AIC</span> - <span class="no">minAIC</span>,<span class="fl">1</span>)
<span class="no">df.mods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Model</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="fl">1</span>:<span class="no">n.mods</span>), <span class="kw">Selectivity</span><span class="kw">=</span><span class="no">sel_model</span>,
                            <span class="st">"Block1_re"</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">sel_re</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span><span class="kw">[[</span><span class="fl">1</span>]]),
                            <span class="st">"Converged"</span><span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">conv</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>),
                            <span class="st">"NLL"</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">x</span>$<span class="no">opt</span>$<span class="no">objective</span>,<span class="fl">3</span>)),
                            <span class="st">"runtime"</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">runtime</span>)), <span class="no">df.aic</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">df.mods</span>) <span class="kw">&lt;-</span> <span class="kw">NULL</span>
<span class="no">df.mods</span></pre></body></html></div>
<pre><code>#&gt;   Model  Selectivity Block1_re Converged       NLL runtime dAIC     AIC
#&gt; 1    m1     logistic      none       Yes  -788.748    0.20 54.5 -1449.5
#&gt; 2    m2     logistic       iid       Yes  -811.603    0.28 10.8 -1493.2
#&gt; 3    m3     logistic       ar1       Yes  -788.748    0.31 58.5 -1445.5
#&gt; 4    m4     logistic     ar1_y        No  -815.888    0.34   NA      NA
#&gt; 5    m5     logistic     2dar1       Yes  -818.980    0.31  0.0 -1504.0
#&gt; 6    m6 age-specific      none       Yes  -806.515    0.19 37.0 -1467.0
#&gt; 7    m7 age-specific       iid        No 98222.812    3.99   NA      NA
#&gt; 8    m8 age-specific     ar1_y       Yes  -811.522    0.31 31.0 -1473.0
#&gt; 9    m9 age-specific     2dar1        No       NaN    1.68   NA      NA</code></pre>
<p>Prepare to plot selectivity-at-age for block 1 (fleet).</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">viridis</span>)

<span class="no">selAA</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="fu">report</span>()$<span class="no">selAA</span><span class="kw">[[</span><span class="fl">1</span>]])
<span class="no">sel_mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Age-specific"</span>,<span class="st">"Logistic"</span>)[<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">env</span>$<span class="no">data</span>$<span class="no">selblock_models</span>[<span class="fl">1</span>])]
<span class="no">sel_cor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"None"</span>,<span class="st">"IID"</span>,<span class="st">"AR1"</span>,<span class="st">"AR1_y"</span>,<span class="st">"2D AR1"</span>)[<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">env</span>$<span class="no">data</span>$<span class="no">selblock_models_re</span>[<span class="fl">1</span>])]
<span class="no">df.selAA</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">NA</span>, <span class="kw">nrow</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">11</span>))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">df.selAA</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Age_"</span>,<span class="fl">1</span>:<span class="fl">6</span>),<span class="st">"Year"</span>,<span class="st">"Model"</span>,<span class="st">"conv"</span>,<span class="st">"sel_mod"</span>,<span class="st">"sel_cor"</span>)
<span class="kw">for</span>(<span class="no">m</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n.mods</span>){
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">selAA</span><span class="kw">[[</span><span class="no">m</span>]])
    <span class="no">df</span>$<span class="no">Year</span> <span class="kw">&lt;-</span> <span class="no">input</span>$<span class="no">years</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Age_"</span>,<span class="fl">1</span>:<span class="fl">6</span>),<span class="st">"Year"</span>)
    <span class="no">df</span>$<span class="no">Model</span> <span class="kw">&lt;-</span> <span class="no">m</span>
    <span class="no">df</span>$<span class="no">conv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">df.mods</span>$<span class="no">Converged</span>[<span class="no">m</span>]<span class="kw">==</span><span class="st">"Yes"</span>,<span class="fl">1</span>,<span class="fl">0</span>)
    <span class="no">df</span>$<span class="no">sel_mod</span> <span class="kw">=</span> <span class="no">sel_mod</span>[<span class="no">m</span>]
    <span class="no">df</span>$<span class="no">sel_cor</span> <span class="kw">=</span> <span class="no">sel_cor</span>[<span class="no">m</span>]
    <span class="no">df.selAA</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">df.selAA</span>, <span class="no">df</span>)
}
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="no">df.selAA</span> <span class="kw">%&gt;%</span> <span class="fu">pivot_longer</span>(-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">Year</span>,<span class="no">Model</span>,<span class="no">conv</span>,<span class="no">sel_mod</span>,<span class="no">sel_cor</span>),
                <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"Age"</span>,
                <span class="kw">names_prefix</span> <span class="kw">=</span> <span class="st">"Age_"</span>,
                <span class="kw">names_ptypes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">Age</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span>()),
                <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"Selectivity"</span>)
<span class="no">df</span>$<span class="no">sel_mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">df</span>$<span class="no">sel_mod</span>, <span class="kw">levels</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Logistic"</span>,<span class="st">"Age-specific"</span>))
<span class="no">df</span>$<span class="no">sel_cor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">df</span>$<span class="no">sel_cor</span>, <span class="kw">levels</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"None"</span>,<span class="st">"IID"</span>,<span class="st">"AR1"</span>,<span class="st">"AR1_y"</span>,<span class="st">"2D AR1"</span>))</pre></body></html></div>
<p>Now plot selectivity-at-age for block 1 (fleet) in all models, with unconverged models pale and converged models solid.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu">ggplot</span>(<span class="no">df</span>, <span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">Year</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">Age</span>)) +
    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="kw">fill</span><span class="kw">=</span><span class="no">Selectivity</span>, <span class="kw">alpha</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">conv</span>))) +
    <span class="fu">scale_alpha_discrete</span>(<span class="kw">range</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.4</span>,<span class="fl">1</span>), <span class="kw">guide</span><span class="kw">=</span><span class="fl">FALSE</span>) +
    <span class="fu">theme_bw</span>() +
    <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">Year</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">Age</span>, <span class="kw">label</span><span class="kw">=</span><span class="no">lab</span>), <span class="kw">size</span><span class="kw">=</span><span class="fl">5</span>, <span class="kw">alpha</span><span class="kw">=</span><span class="fl">1</span>, <span class="co">#fontface = "bold",</span>
      <span class="kw">data</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Year</span><span class="kw">=</span><span class="fl">1975.5</span>, <span class="kw">Age</span><span class="kw">=</span><span class="fl">5.8</span>, <span class="kw">lab</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">mods</span>)), <span class="kw">sel_mod</span><span class="kw">=</span><span class="no">sel_mod</span>, <span class="kw">sel_cor</span><span class="kw">=</span><span class="no">sel_cor</span>)) +
    <span class="fu">scale_x_continuous</span>(<span class="kw">expand</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">0</span>)) +
    <span class="fu">scale_y_continuous</span>(<span class="kw">expand</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">0</span>)) +
    <span class="fu">facet_grid</span>(<span class="kw">rows</span><span class="kw">=</span><span class="fu">vars</span>(<span class="no">sel_cor</span>), <span class="kw">cols</span><span class="kw">=</span><span class="fu">vars</span>(<span class="no">sel_mod</span>)) +
    <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>())</pre></body></html></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex4_plots/selAA.png" style="width:90.0%"></p>
<div id="a-note-on-convergence" class="section level4">
<h4 class="hasAnchor">
<a href="#a-note-on-convergence" class="anchor"></a>A note on convergence</h4>
<p>When fitting age-specific selectivity, oftentimes some of the (mean, <span class="math inline">\(\mu^{s}_a\)</span>) selectivity parameters need to be fixed for the model to converge. The specifications used here follow this procedure:</p>
<ol style="list-style-type: decimal">
<li>Fit the model without fixing any selectivity parameters.</li>
<li>If the model fails to converge or the hessian is not invertible (i.e. not positive definite), look for mean selectivity parameters that are very close to 0 or 1 (&gt; 5 or &lt; -5 on the logit scale) and/or have <code>NaN</code> estimates of their standard error:</li>
</ol>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">mod</span>$<span class="no">rep</span>$<span class="no">logit_selpars</span> <span class="co"># mean sel pars</span>
<span class="no">mod</span>$<span class="no">rep</span>$<span class="no">sel_repars</span> <span class="co"># if time-varying selectivity turned on</span>
<span class="no">mod</span>$<span class="no">rep</span>$<span class="no">selAA</span> <span class="co"># selectivity-at-age by block</span>
<span class="no">mod</span>$<span class="no">sdrep</span> <span class="co"># look for sel pars with NaN standard errors</span></pre></body></html></div>
<ol start="3" style="list-style-type: decimal">
<li>Re-run the model fixing the worst selectivity-at-age parameter for each block at 0 or 1 as appropriate. In the above age-specific models, we initialized and fixed ages 4, 4, and 2 for blocks 1-3, respectively. Sometimes just initializing the worst parameter is enough, without fixing it.</li>
</ol>
<div class="sourceCode" id="cb20"><html><body><pre class="r">        <span class="no">input</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span>(<span class="no">asap3</span>, <span class="kw">model_name</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Model "</span>,<span class="no">m</span>), <span class="no">sel_model</span>[<span class="no">m</span>], <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">sel_re</span><span class="kw">[[</span><span class="no">m</span>]], <span class="kw">collapse</span><span class="kw">=</span><span class="st">"-"</span>), <span class="kw">sep</span><span class="kw">=</span><span class="st">": "</span>), <span class="kw">recruit_model</span><span class="kw">=</span><span class="fl">2</span>,
                    <span class="kw">selectivity</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">model</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"age-specific"</span>,<span class="fl">3</span>), <span class="kw">re</span><span class="kw">=</span><span class="no">sel_re</span><span class="kw">[[</span><span class="no">m</span>]],
                        <span class="kw">initial_pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">inv.logit</span>(-<span class="fl">4</span>),<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>)),
                        <span class="kw">fix_pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span>)),
                    <span class="kw">NAA_re</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">sigma</span><span class="kw">=</span><span class="st">'rec+1'</span>,<span class="kw">cor</span><span class="kw">=</span><span class="st">'iid'</span>))</pre></body></html></div>
<ol start="4" style="list-style-type: decimal">
<li>The goal is to find a set of selectivity parameter initial/fixed values that allow all nested models to converge. Fixing parameters should not affect the NLL much, and any model that is a superset of another should not have a greater NLL (indicates not converged to global minimum). The following commands may be helpful:</li>
</ol>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">mod.list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span>(),<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"m"</span>,<span class="fl">1</span>:<span class="no">n.mods</span>,<span class="st">".rds"</span>))
<span class="no">mods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">mod.list</span>, <span class="no">readRDS</span>)
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="../reference/check_convergence.html">check_convergence</a></span>(<span class="no">x</span>))
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">opt</span>$<span class="no">obj</span>) <span class="co"># get NLL </span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">rep</span>$<span class="no">logit_selpars</span>)
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">mods</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">rep</span>$<span class="no">sel_repars</span>)</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Tim Miller, Brian Stock.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
